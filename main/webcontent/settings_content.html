	<article>
		<h2>Status</h2>
		<table id="settings"></table>
		<p id="errmsg"></p>
		<table>
			<caption>configurations </caption>
			<tr><th>parameter</th><th>value</th><th>description</th></tr>
			<tr><td>number of leds</td><td><input type="text" id="numleds"></td><td>1 .. 1000</td></tr>
			<tr><td>cycle time</td><td><input type="text" id="cycle"></td><td>in ms, 20 .. 10000</td></tr>
			<tr><td>autoplay</td><td><input type="checkbox" id="autoplay"></td><td>play autoplay file after startup</td></tr>
			<tr><td>show status</td><td><input type="checkbox" id="show_status"></td><td>first led shows status</td></tr>
			<tr><td><button id="restart" type="button" onclick="restart()">restart</button></td><td><button id="store_config" type="button" onclick="storeConfig()">store</button><br></td><td></td></tr>
		</table>


	</article>

<script>

function onBodyLoad() {
	getStatus();
	getConfig();
}

function getStatus() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 ){
		  	if (this.status == 200) {
		   		getStatusFunction(this);
		   	} else {
		   		alert("getStatus failed:" + this.statustext);
		   	}
		}
	};
  	xhttp.open("GET", "sts", true);
	xhttp.send();
}

function getStatusFunction(json) {
    var j = JSON.parse(json.responseText);
    var table="<caption>Settings</caption>";
    table+="<tr><th>Attribute</th><th>Value</th></tr>\n";
    table +="<tr><td>status</td><td>" + j.status +"</td></tr>\n";
    table +="<tr><td>scene time</td><td>" + (j.scene_time/1000).toFixed(3) +" sec </td></tr>\n";
    table +="<tr><td>timer period</td><td>" + j.timer_period +" ms</td></tr>\n";
    table +="<tr><td>last loaded file</td><td>" + j.last_loaded_file +"</td></tr>\n";
    table +="<tr><td>ESP-IDF version</td><td>" + j.version +"</td></tr>\n";
    table +="<tr><td>cores</td><td>" + j.cores +"</td></tr>\n";
    table +="<tr><td>free heap size</td><td>" + j.free_heap_size +" bytes</td></tr>\n";
    table +="<tr><td>minimum free heap size</td><td>" + j.minimum_free_heap_size +" bytes</td></tr>\n";
    table +="<tr><td>filesystem total</td><td>" + j.filesystem_total +" bytes </td></tr>\n";
    table +="<tr><td>filesystem used</td><td>" + j.filesystem_used +" bytes ("+ (100 *j.filesystem_used / j.filesystem_total).toFixed(1)+"%)</td></tr>\n";
    table +="<tr><td>compile_date</td><td>" + j.compile_date +"</td></tr>\n";
    table +="<tr><td>compile_time</td><td>" + j.compile_time +"</td></tr>\n";
    table +="<tr><td>app_version</td><td>" + j.app_version +"</td></tr>\n";
    document.getElementById("settings").innerHTML = table;
}

//configuration handling
var j;


function checkNumber(elementname, min_value, max_value) {
	var numvar = Number.parseInt(document.getElementById(elementname).value, 10);
	if ( isNaN(numvar) || numvar < min_value || numvar > max_value) {
		throw 'invalid value for "' + elementname+'" expected values: ' + min_value + '..' +max_value;
	}
	return numvar;
}

function storeConfig() {
	var changed=false;
	var newJ = {};
	var n;
	var chk;
	var changed;
	try {
		n = checkNumber("numleds", 1, 1000);
		if ( n != j.numleds) {
			newJ.numleds = n;
			changed = true;
		}
		n = checkNumber("cycle", 20,10000);
		if ( n != j.cycle) {
			newJ.cycle = n;
			changed = true;
		}
		chk = document.getElementById("autoplay").checked;
		if ( chk != j.autoplay) {
			newJ.autoplay = chk;
			changed = true;
		}
		chk = document.getElementById("show_status").checked;
		if ( chk != j.show_status) {
			newJ.show_status = chk;
			changed = true;
		}
		if ( !changed) {
			alert("no changes");
			return;
		}
		//alert("store " + JSON.stringify(newJ));
		setConfig(newJ);
	} catch(err) {
		alert('storeConfig failed:' + err);
    	fillConfigValues();
	}
}

function fillConfigValues() {
	document.getElementById("numleds").value = j.numleds;
	document.getElementById("cycle").value = j.cycle;
	document.getElementById("autoplay").checked = j.autoplay;
	document.getElementById("show_status").checked = j.show_status;
}

function getConfig() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	 	if (this.readyState == 4 ){
	 		if (this.status == 200) {
	 	    	j = JSON.parse(this.responseText);
	 	    	fillConfigValues();
	 		} else {
	 			alert("getConfig failed: " + this.statustext);
	 		}
	 	}
	};
	xhttp.open("GET", "cfg/get", true);
	xhttp.send();
}

function setConfig(newJ) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	 	if (this.readyState == 4 ){
	 		if (this.status == 200) {
	 	    	j = JSON.parse(this.responseText);
	 	    	fillConfigValues();
	 		} else {
	 			alert("setConfig failed: " + this.statustext);
	 		}
	 	}
	};
	xhttp.open("POST", "cfg/set", true);
	xhttp.send(JSON.stringify(newJ));
}

function restart() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	 	if (this.readyState == 4 ){
	 		if (this.status == 200) {
	 			alert(this.responseText);
	 		} else {
	 			alert("restart failed: " + this.statustext);
	 		}
	 	}
	};
	xhttp.open("GET", "cfg/restart", true);
	xhttp.send();
}
</script>
<noscript>
	<p>no script</p>
</noscript>
